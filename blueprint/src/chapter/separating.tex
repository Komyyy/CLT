\chapter{Separating subalgebras}

\begin{definition}\label{def:separates_points}
\mathlibok
\lean{Set.SeparatesPoints}
A set $\mathcal F$ of functions $E \to F$ separates points in $E$ if for all $x, y \in E$ with $x \ne y$, there exists $f \in \mathcal F$ with $f(x) \ne f(y)$.
\end{definition}

\begin{definition}\label{def:separating}
\lean{MeasureTheory.Separating} \leanok
A set $\mathcal F$ of functions $E \to F$ is separating in $\mathcal P(E)$ if for all probability measures $\mu, \nu$ on $E$ with $\mu \ne \nu$, there exists $f \in \mathcal F$ with $\mu[f] \ne \nu[f]$.
\end{definition}


\begin{lemma}\label{lem:bounded_continuous_separating}
\uses{def:separating}
In a Borel space $E$, the set $C_b(E, \mathbb{C})$ of bounded continuous functions from $E$ to $\mathbb{C}$ is separating in $\mathcal P(E)$.
\end{lemma}

\begin{proof}
The Mathlib lemma \texttt{MeasureTheory.FiniteMeasure.ext\_of\_forall\_lintegral\_eq} shows that $C_b(E, \mathbb{R}_+)$ is separating. Since $C_b(E, \mathbb{R}_{+}) \subseteq C_b(E, \mathbb{C})$, the larger set is also separating.
\end{proof}


\begin{lemma}\label{lem:exp_character}
\lean{Clt.expInnerMulI} \leanok
$x \mapsto (t \mapsto \exp(i \langle t, x \rangle))$ is a monoid homomorphism from $(E,+)$ to $C_b(E, \mathbb{C})$.
\end{lemma}

\begin{proof}\leanok
\end{proof}


\begin{lemma}\label{lem:starSubalgebra_expPoly}
\lean{Clt.expPoly} \leanok
The functions of the form $x \mapsto \sum_{k=1}^n a_k e^{i\langle t_k, x\rangle}$ for $n \in \mathbb{N}$, $a_1, \ldots, a_n \in \mathbb{R}$ and $t_1, \ldots, t_n \in E$ are a star-subalgebra of $C_b(E, \mathbb{C})$. 
\end{lemma}

\begin{proof}\uses{lem:exp_character} \leanok
The monoid homomorphism can be lifted to a homomorphism of algebras from \texttt{AddMonoidAlgebra ℝ E} to $C_b(E, \mathbb{C})$ using \texttt{AddMonoidAlgebra.lift}. $\mathcal M$ is the range of this homomorphism. The ``star'' part can be checked easily.
\end{proof}


Let $\mathcal M$ be the set of these functions, which we call exponential polynomials.

\begin{lemma}\label{lem:separates_points_expPoly}
\lean{Clt.expPoly_separatesPoints} \leanok
\uses{lem:starSubalgebra_expPoly}
The star-subalgebra $\mathcal M$ separates points.
\end{lemma}

\begin{proof}
TODO
\end{proof}


\begin{lemma}\label{lem:integral_restrict_compact}
\mathlibok
\lean{abs_integral_sub_setIntegral_mulExpNegMulSq_comp_lt}
Let $\mu$ be a finite measure on a Borel space $E$ and let $K$ be a measurable compact set such that $\mu(K^c) \le \varepsilon$. Let $f \in C(E, \mathbb{R})$. Then
\begin{align*}
\left\vert \mu[fe^{-\varepsilon \Vert f \Vert^2}] - \mu[f e^{-\varepsilon \Vert f \Vert^2} \mathbb{I}_K] \right\vert
\le \sqrt{\varepsilon} \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
\end{proof}


\begin{lemma}\label{lem:introduce_exponential}
\mathlibok
\lean{tendsto_integral_mulExpNegMulSq_comp}
For any $f \in C_b(E, \mathbb{R})$ and a probability measure $\mu$,
\begin{align*}
\mu[f] 
= \lim_{\varepsilon \to 0} \mu\left[f e^{-\varepsilon \Vert f \Vert^2} \right]
\: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
\end{proof}


\begin{lemma}\label{lem:dist_integral_mulExpNegMulSq_comp_le}
\mathlibok
\lean{dist_integral_mulExpNegMulSq_comp_le}
Let $\mu, \nu$ be two finite measures in a standard Borel space $E$. Let $\mathcal{A}$ be a subalgebra of $C_b(E, \mathbb{R})$ that separates points.
If for all $g \in \mathcal A$, $\mu[g] = \nu[g]$, then for all $f \in C_b(E, \mathbb{R})$ and all $\varepsilon > 0$,
\begin{align*}
    \left\vert \mu[fe^{-\varepsilon \Vert f \Vert^2}] - \nu[f e^{-\varepsilon \Vert f \Vert^2}] \right\vert
    \le 6\sqrt{\varepsilon} \: .
\end{align*}
\end{lemma}

\begin{proof}\leanok
\uses{lem:integral_restrict_compact}
\end{proof}


\begin{lemma}\label{lem:Cb_eq_of_separating}
\uses{def:separates_points}
Let $\mu, \nu$ be two finite measures in a standard Borel space $E$. Let $\mathcal{A}$ be a star-subalgebra of $C_b(E, \mathbb{k})$ that separates points, where $\mathbb{k}$ is $\mathbb{R}$ or $\mathbb{C}$.
If for all $g \in \mathcal A$, $\mu[g] = \nu[g]$, then for all $f \in C_b(E, \mathbb{k})$, $\mu[f] = \nu[f]$.
\end{lemma}

\begin{proof}
\uses{lem:introduce_exponential, lem:dist_integral_mulExpNegMulSq_comp_le}
Proved in Mathlib PR \#19782
\end{proof}


\begin{theorem}[Subalgebras separating points]\label{thm:separating_starSubalgebra}
Let $E$ be a complete separable pseudo-metric space. Let $\mathcal A \subseteq C_b(E, \mathbb{C})$ be a star-subalgebra that separates points. Then $\mathcal A$ is separating in $\mathcal P(E)$.
\end{theorem}

\begin{proof}\uses{lem:bounded_continuous_separating, lem:Cb_eq_of_separating}
Let $\mu$ and $\nu$ be two probability measures such that $\mu[f] = \nu[f]$ for all $f \in \mathcal A$. We want to prove that $\mu = \nu$. Since $C_b(E, \mathbb{C})$ is separating, it suffices to prove that for $g \in C_b(E, \mathbb{C})$, $\mu[g] = \nu[g]$. This is proved in Lemma~\ref{lem:Cb_eq_of_separating}
\end{proof}


\begin{lemma}\label{lem:separating_expPoly}
The exponential polynomials $\mathcal M$ are separating.
\end{lemma}

\begin{proof}\uses{thm:separating_starSubalgebra, lem:separates_points_expPoly}
Apply Theorem~\ref{thm:separating_starSubalgebra}, using Lemma~\ref{lem:separates_points_expPoly}.
\end{proof}


\begin{lemma}\label{lem:cvg_of_separating}
Let $\mathcal A$ be a separating subalgebra of $C_b(E, \mathbb{C})$. Let $\mu, \mu_1, \mu_2, \ldots$ be probability measures, with $(\mu_n)$ tight. If for all $f \in \mathcal A$, $\mu_n[f] \to \mu[f]$, then $\mu_n \xrightarrow{w} \mu$.
\end{lemma}

\begin{proof}\uses{def:separating, lem:relatively_compact_of_tight}
To show convergence to $\mu$, it suffices to show that every subsequence has a subsequence that converges to $\mu$ (\texttt{Filter.tendsto\_of\_subseq\_tendsto}).
Since the family is tight, it is relatively compact by Prokhorov's theorem. We get that each subsequence has a converging subsequence.
Let then $\mu'$ be a weak limit of $\mu_n$. We have $\mu_n[f] \to \mu'[f]$ and $\mu_n[f] \to \mu[f]$ for all $f \in \mathcal A$, hence $\mu'[f] = \mu[f]$ for all $f \in \mathcal A$. Since $\mathcal A$ is separating, $\mathcal \mu' = \mu$.
\end{proof}
